---
title: "PUMS Educ Crosstabs"
author: "Dan Swart"
format: html
---


# PUMAs for SCUC-ISD      
For your PUMS analysis, use these PUMA codes:
  
  # Define the PUMAs that cover SCUC ISD area
  scuc_pumas <- c("05700", "05916")  # Remove the "48" state prefix for PUMS data
  
  # Filter your education data for these PUMAs
  scuc_education_data <- education_data %>%
    dplyr::filter(PUMA %in% scuc_pumas)
  
  # Or if you want to include surrounding areas for comparison:
  extended_area_pumas <- c(
    "05700",  # Guadalupe County (Schertz, Cibolo)
    "05916",  # Bexar County Northeast (Universal City)
    "05800",  # Comal County (adjacent northern area)
    "05915"   # Bexar County North (adjacent area)
  )
  
  cat("SCUC ISD area PUMAs: 05700 (Guadalupe County), 05916 (Bexar County Northeast)\n")




```{r}

library(tidyverse)
library(tidycensus)

```


STEP 1: Define your comparison groups and outcomes


# STEP 1: Use available years and variables

```{r}

working_years <- 2017:2022  # 6 years of data
working_vars <- c("SCHL", "FOD1P", "FOD2P", "RAC1P", "HISP", "AGEP", "SEX",
                  "HINCP", "POVPIP", "NP", "HHT", "MAR", "WAGP", "WKHP", "ESR")
# Note: Removed NPOC since it doesn't exist

cat("Downloading PUMS data for", length(working_years), "years with", length(working_vars), "variables...\n")

```

# STEP 2: Download and standardize data types for each year (this will take a while)

```{r}

# Download and standardize only existing columns
education_data_list <- purrr::map(working_years, ~{
  cat("Downloading year", .x, "...\n")
  
  year_data <- tidycensus::get_pums(
    variables = working_vars,
    state = "TX",
    year = .x,
    survey = "acs5"
  ) 
  
  # Check what columns we actually got
  cat("  Columns received:", paste(names(year_data), collapse = ", "), "\n")
  
  # Add year and standardize only existing columns
  year_data <- year_data %>%
    dplyr::mutate(
      year = .x,
      
      # Standardize columns that exist in our requested variables
      AGEP = as.numeric(AGEP),
      HINCP = as.numeric(HINCP),
      WAGP = as.numeric(WAGP),
      WKHP = as.numeric(WKHP),
      POVPIP = as.numeric(POVPIP),
      NP = as.numeric(NP),
      
      # Character variables from our list
      RAC1P = as.character(RAC1P),
      HISP = as.character(HISP),
      SEX = as.character(SEX),
      MAR = as.character(MAR),
      ESR = as.character(ESR),
      HHT = as.character(HHT),
      SCHL = as.character(SCHL),
      FOD1P = as.character(FOD1P),
      FOD2P = as.character(FOD2P)
    )
  
  # Standardize automatic columns if they exist
  if("PWGTP" %in% names(year_data)) {
    year_data$PWGTP <- as.numeric(year_data$PWGTP)
  }
  if("SPORDER" %in% names(year_data)) {
    year_data$SPORDER <- as.character(year_data$SPORDER)
  }
  if("PUMA" %in% names(year_data)) {
    year_data$PUMA <- as.character(year_data$PUMA)
  }
  if("SERIALNO" %in% names(year_data)) {
    year_data$SERIALNO <- as.character(year_data$SERIALNO)
  }
  if("ST" %in% names(year_data)) {
    year_data$ST <- as.character(year_data$ST)
  }
  
  return(year_data)
})

# Combine the datasets
education_data <- dplyr::bind_rows(education_data_list)

cat("Download complete! Data dimensions:", dim(education_data), "\n")

```


STEP 3: Create analysis-ready dataset 

```{r}

# Create analysis-ready dataset with proxy for children
analysis_ready <- education_data %>%
  dplyr::mutate(
    # Define racial/ethnic groups using CORRECT character comparisons
    race_ethnicity = dplyr::case_when(
      RAC1P == "1" & HISP == "01" ~ "White_NH",      # White, not Hispanic
      RAC1P == "2" & HISP == "01" ~ "Black_NH",      # Black, not Hispanic
      RAC1P == "6" & HISP == "01" ~ "Asian_NH",      # Asian, not Hispanic
      HISP == "02" ~ "Hispanic",                     # Hispanic (any race)
      TRUE ~ "Other"
    ),
    
    # Convert SCHL to numeric (handles leading zeros automatically)
    SCHL_num = as.numeric(SCHL),  # "21" becomes 21, "bb" becomes NA
    college_plus = ifelse(SCHL_num >= 21, 1, 0),
    graduate_degree = ifelse(SCHL_num >= 22, 1, 0),
    
    # Demographics and controls
    age_group = cut(AGEP, breaks = c(0, 25, 35, 45, 55, 65, 100)),
    married = ifelse(MAR == "01", 1, 0),             # Married is probably "01"
    income_quintile = dplyr::ntile(HINCP, 5),
    full_time = ifelse(WKHP >= 35, 1, 0),
    
    # Proxy for having children - need to check HHT codes
    likely_has_children = dplyr::case_when(
      HHT %in% c("01", "02") & NP >= 3 ~ 1,         # Family households with 3+ people
      HHT %in% c("03", "04") & NP >= 2 ~ 1,  
      TRUE ~ 0
    )
  ) %>%
  dplyr::filter(
    AGEP >= 25 & AGEP <= 65,  # Working age adults
    race_ethnicity != "Other",
    !is.na(SCHL_num)  # Remove records with invalid education codes
  )

cat("Fixed analysis dataset dimensions:", dim(analysis_ready), "\n")

# Check the race/ethnicity distribution
cat("Race/ethnicity distribution:\n")
print(table(analysis_ready$race_ethnicity, useNA = "always"))

```



STEP 4: Example hypothesis test

```{r}

# Hypothesis 1: Racial achievement gaps controlling for socioeconomic factors
hypothesis_1 <- analysis_ready %>%
  dplyr::filter(AGEP >= 30 & AGEP <= 40) %>%  # Peak career-building years
  dplyr::group_by(year, race_ethnicity, income_quintile, likely_has_children, married) %>%
  dplyr::summarise(
    college_plus_rate = stats::weighted.mean(college_plus, PWGTP, na.rm = TRUE),
    graduate_degree_rate = stats::weighted.mean(graduate_degree, PWGTP, na.rm = TRUE),
    n = sum(PWGTP), 
    .groups = "drop"
  ) %>%
  dplyr::filter(n >= 30)  # Minimum sample size for reliable estimates

# Create the line graph test
ggplot2::ggplot(hypothesis_1, ggplot2::aes(x = year, y = college_plus_rate, color = race_ethnicity)) +
  ggplot2::geom_line(size = 1.2) +
  ggplot2::facet_wrap(~paste("Income Q", income_quintile, "| Children:", likely_has_children)) +
  ggplot2::labs(
    title = "College Completion Rates: Apples-to-Apples Comparison",
    subtitle = "Controlling for income and family structure",
    y = "College Completion Rate",
    caption = "If gaps persist within same income/family groups, socioeconomic factors don't explain them"
  ) +
  ggplot2::theme_minimal()

```





