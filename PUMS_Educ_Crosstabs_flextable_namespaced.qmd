---
title: "PUMS Educ Crosstabs"
subtitle: ""
description: ""
authors: 
  - name: "Dan Swart, CPA (ret)"
  - name: "Claude Sonnet 4.5"
date: today
date-format: long
# bibliography: manual-refs.bib
format:
  html:
    resources:
      - reference-backlinks.js
    include-after-body:    
      - text: |
          # <script type="text/javascript" src="reference-backlinks.js"></script>
    default: true         
    code-copy: true
    code-link: true        # This adds individual buttons
    code-fold: true        # Hide code by default, show on click
    code-summary: "Show the code"
    code-overflow: wrap
    code-block-bg: "#FAEBD7"
    code-block-border-left: "#31BAE9"
    embed-resources: false     # Fast for drafts. Override for sharing output
    include-in-header:
      - text: 
          <link href="https://fonts.googleapis.com/css2?family=Lato&display=swap" rel="stylesheet">
          <link href="https://fonts.googleapis.com/css2?family=Fira+Mono&display=swap" rel="stylesheet">
          <link href="https://fonts.googleapis.com/css2?family=Montserrat&display=swap" rel="stylesheet">
          <link href="https://fonts.googleapis.com/css2?family=Cabin&display=swap" rel="stylesheet">
          <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab&display=swap" rel="stylesheet">
          <link href="https://fonts.googleapis.com/css2?family=Schoolbell&display=swap" rel="stylesheet">
      - header.html
    css:
      - swart.css
      - tachyons.min.css
      - r-colors.css
    fontsize: 18pt
    lightbox: true
    page-layout: full
    fig-width: 12
    fig-height: 10
    fig-dpi: 300
    html-math-method: katex
    df-print: paged
    toc: true
    toc-float: true
    citeproc: true
    link-citations: true
    linestretch: 1.0
    
    
    
  typst:
    fig-width: 12
    fig-height: 10
    fig-dpi: 300
    margin:
      x: 1in
      y: 1in
    toc: true
    fontsize: 16pt
    mainfont: "Cabin"
  

    
  revealjs:
    slide-number: true
    transition: fade
    code-overflow: wrap
    center: true
    smaller: true
    scrollable: true
    chalkboard: true
    multiplex: false
    theme: solarized
    reference-location: margin
    logo: img/red-cross-640-435.png
    footer: "Footer text"
    code-block-height: 650px



  # docx:
  #   highlight-style: github
  #   fig_caption: true



editor: source

quarto:
  render:
    cache-refresh: true


# for .qmd filesd
execute:
  echo: true
  message: false
  warning: false
  eval: true
  fig-width: 12
  fig-height: 10


# for .rmd files
knitr:
  opts_chunk:
    echo: true
    error: false
    warning: false
    message: false
    cache: false


---


```{r}
#| label: setup
#| include: false


# install.packages(c("mapview", "survey", "srvyr", "arcgislayers"))

# census_api_key("95496766c51541ee6f402c1e1a8658581285b759", install = TRUE, overwrite = TRUE)


# # load libraries - NOT NEEDED


# Force dplyr's select to take precedence
select <- dplyr::select
filter <- dplyr::filter

# Options
base::options(scipen = 999)
base::options(qic.clshade = TRUE) # NO LONGER NEEDED; CHARTS ALL PREPARED WITH GGPLOT2 ONLY
base::options(qic.linecol = 'black') # NO LONGER NEEDED; CHARTS ALL PREPARED WITH GGPLOT2 ONLY
base::options(qic.signalcol = "firebrick") # NO LONGER NEEDED; CHARTS ALL PREPARED WITH GGPLOT2 ONLY
base::options(qic.targetcol = "purple") # NO LONGER NEEDED; CHARTS ALL PREPARED WITH GGPLOT2 ONLY
base::options(DT.options = base::list(dom = 'pBlfrti')) # Add buttons, filtering, and top (t) pagination controls
base::options(shiny.maxRequestSize = 50 * 1024^2) # Set upload maximum to 50 MB
base::options(tigris_use_cache = TRUE)
base::options(device = "RStudioGD") 


# Flextable defaults:
flextable::set_flextable_defaults(
  font.size = 14, 
  font.family = "Cabin",
  font.color = "black",
  table.layout = "fixed",
  border.color = "darkgray",
  padding.top = 3, padding.bottom = 3,
  padding.left = 4, padding.right = 4,
  line_spacing = 1.3,
  digits = 2,
  decimal.mark = ".",
  big.mark = " ",
  na_str = "<na>",
  post_process_html = identity,
  post_process_docx = identity
)


# Set global theme for consistent plots
ggplot2::theme_set(
  ggplot2::theme_minimal(base_size = 20) +
    ggplot2::theme(
      plot.title.position = "plot",
      plot.title = ggtext::element_textbox_simple(
        family = "Cabin",
        face = "bold",
        color = "darkgreen",
        size = 26,
        fill = "yellow",
        lineheight = 1.2,
        padding = ggplot2::margin(5.5, 5.5, 0.0, 5.5),
        margin = ggplot2::margin(0, 0, 5.5, 0)
      ),
      plot.subtitle = ggtext::element_textbox_simple(
        family = "Cabin",
        color = "darkgreen",
        face = "bold",
        size = 24,
        fill = "yellow",
        lineheight = 1.2,
        padding = ggplot2::margin(5.5, 5.5, 5.5, 5.5),
        margin = ggplot2::margin(10.5, 0, 5.5, 0)
      ),
      plot.caption = ggtext::element_markdown(
        family = "Cabin",
        size = 22,
        hjust = 1,
        color = "darkblue",
        face = "italic",
        fill = "yellow",
        lineheight = 1.0
      ),
      axis.text.x = ggtext::element_markdown(
        family = "Cabin",
        face = "bold",
        color = "blue",
        size = 20,
        angle = 45,
        hjust = 1
      ),
      axis.title.x = ggtext::element_markdown(
        family = "Cabin",
        face = "bold",
        color = "blue",
        size = 20),
      axis.text.y = ggtext::element_markdown(
        family = "Cabin",
        face = "bold",
        color = "blue",
        size = 20,
        angle = 45,
        hjust = 1
      ),
      axis.title.y = ggtext::element_markdown(
        family = "Cabin",
        face = "bold",
        color = "blue",
        size = 20),
      strip.text = ggtext::element_markdown(
        family = "Cabin",
        color = "black",
        size = ggplot2::rel(1.1),
        face = "italic",
        margin = ggplot2::margin(2, 0, 0.5, 0, "lines")
      ),
      axis.text = ggtext::element_markdown(
        family = "Cabin",
        color = "black"),
      panel.background = ggplot2::element_rect(fill = "white", color = NA),
      plot.background = ggplot2::element_rect(fill = "white", color = NA),
      legend.position = "none",
      panel.spacing.x = grid::unit(1.5, "cm"),
      panel.spacing.y = grid::unit(1.5, "cm"),
      plot.margin = ggplot2::margin(20, 20, 20, 20, "pt")
    )
)


# Canonical caching function for Census API calls
cache_census_api_call <- function(
    type = c("acs", "pums", "variables", "decennial"),
    year = 2023,
    survey = "acs5",
    state = NULL,
    puma = NULL,
    geography = NULL,
    table = NULL,
    variables = NULL,
    cache_dir = "data",
    force_refresh = FALSE
) {
  type <- base::match.arg(type)
  
  state_str <- if (base::is.null(state)) {
    "none"
  } else if (base::length(state) == 1 && state == "all") {
    "all"
  } else {
    base::paste(base::sort(state), collapse = "-")
  }
  
  puma_str <- if (!base::is.null(puma)) {
    base::paste0("_puma", base::paste(base::sort(puma), collapse = "-"))
  } else {
    ""
  }
  
  vars_str <- if (!base::is.null(variables)) {
    base::paste0("_", base::substr(rlang::hash(variables), 1, 8))
  } else if (!base::is.null(table)) {
    base::paste0("_", table)
  } else {
    ""
  }
  
  geo_str <- if (!base::is.null(geography)) {
    base::paste0("_", geography)
  } else {
    ""
  }
  
  cache_file <- base::file.path(
    cache_dir,
    base::paste0(type, "_", survey, "_", year, "_", state_str, puma_str, geo_str, vars_str, ".rds")
  )
  
  if (!base::dir.exists(cache_dir)) {
    base::dir.create(cache_dir, recursive = TRUE)
  }
  
  if (base::file.exists(cache_file) && !force_refresh) {
    base::message("Loading from cache: ", cache_file)
    base::return(base::readRDS(cache_file))
  }
  
  base::message("Fetching from API...")
  
  result <- base::switch(
    type,
    variables = tidycensus::load_variables(year, survey),
    acs = tidycensus::get_acs(
      geography = geography,
      table = table,
      variables = variables,
      state = state,
      year = year,
      survey = survey
    ),
    pums = tidycensus::get_pums(
      variables = variables,
      state = state,
      puma = puma,
      year = year,
      survey = survey
    ),
    decennial = tidycensus::get_decennial(
      geography = geography,
      variables = variables,
      state = state,
      year = year
    )
  )
  
  base::saveRDS(result, cache_file)
  base::message("Cached to: ", cache_file)
  result
}

  
# Set seed for reproducibility
base::set.seed(123)

```


# PUMAs for SCUC-ISD      
For your PUMS analysis, use these PUMA codes:
  
  # Define the PUMAs that cover SCUC ISD area
  scuc_pumas <- c("05700", "05916")  # Remove the "48" state prefix for PUMS data
  
  # Filter your education data for these PUMAs
  scuc_education_data <- education_data |>
    dplyr::filter(PUMA %in% scuc_pumas)
  
  # Or if you want to include surrounding areas for comparison:
  extended_area_pumas <- c(
    "05700",  # Guadalupe County (Schertz, Cibolo)
    "05916",  # Bexar County Northeast (Universal City)
    "05800",  # Comal County (adjacent northern area)
    "05915"   # Bexar County North (adjacent area)
  )


STEP 1: Define your comparison groups and outcomes


# STEP 1: Use available years and variables

```{r}
#| label: step1-define-variables
#| message: false
#| warning: false
#| results: hide

working_years <- 2017:2022  # 6 years of data
working_vars <- c("SCHL", "FOD1P", "FOD2P", "RAC1P", "HISP", "AGEP", "SEX",
                  "HINCP", "POVPIP", "NP", "HHT", "MAR", "WAGP", "WKHP", "ESR")
# Note: Removed NPOC since it doesn't exist

cat("Downloading PUMS data for", base::length(working_years), "years with", base::length(working_vars), "variables...\n")

```

# STEP 2: Download and standardize data types for each year (this will take a while)

```{r}
#| label: step2-download-data
#| cache: true
#| message: false
#| warning: false
#| results: hide

# Download and standardize only existing columns using cache function
education_data_list <- purrr::map(working_years, \(yr) {
  cat("Downloading year", yr, "...\n")
  
  year_data <- cache_census_api_call(
    type = "pums",
    year = yr,
    survey = "acs5",
    state = "TX",
    variables = working_vars
  )
  
  # Check what columns we actually got
  cat("  Columns received:", base::paste(base::names(year_data), collapse = ", "), "\n")
  
  # Add year and standardize only existing columns
  year_data <- year_data |>
    dplyr::mutate(
      year = yr,
      
      # Standardize columns that exist in our requested variables
      AGEP = base::as.numeric(AGEP),
      HINCP = base::as.numeric(HINCP),
      WAGP = base::as.numeric(WAGP),
      WKHP = base::as.numeric(WKHP),
      POVPIP = base::as.numeric(POVPIP),
      NP = base::as.numeric(NP),
      
      # Character variables from our list
      RAC1P = base::as.character(RAC1P),
      HISP = base::as.character(HISP),
      SEX = base::as.character(SEX),
      MAR = base::as.character(MAR),
      ESR = base::as.character(ESR),
      HHT = base::as.character(HHT),
      SCHL = base::as.character(SCHL),
      FOD1P = base::as.character(FOD1P),
      FOD2P = base::as.character(FOD2P)
    )
  
  # Standardize automatic columns if they exist
  if("PWGTP" %in% base::names(year_data)) {
    year_data$PWGTP <- base::as.numeric(year_data$PWGTP)
  }
  if("SPORDER" %in% base::names(year_data)) {
    year_data$SPORDER <- base::as.character(year_data$SPORDER)
  }
  if("PUMA" %in% base::names(year_data)) {
    year_data$PUMA <- base::as.character(year_data$PUMA)
  }
  if("SERIALNO" %in% base::names(year_data)) {
    year_data$SERIALNO <- base::as.character(year_data$SERIALNO)
  }
  if("ST" %in% base::names(year_data)) {
    year_data$ST <- base::as.character(year_data$ST)
  }
  
  base::return(year_data)
})

# Combine the datasets
education_data <- dplyr::bind_rows(education_data_list)

cat("Download complete! Data dimensions:", base::dim(education_data), "\n")

```


STEP 3: Create analysis-ready dataset 

```{r}
#| label: step3-create-analysis-data
#| message: false
#| warning: false
#| results: hide

# Create analysis-ready dataset with proxy for children
analysis_ready <- education_data |>
  dplyr::mutate(
    # Define racial/ethnic groups using CORRECT character comparisons
    race_ethnicity = dplyr::case_when(
      RAC1P == "1" & HISP == "01" ~ "White_NH",      # White, not Hispanic
      RAC1P == "2" & HISP == "01" ~ "Black_NH",      # Black, not Hispanic
      RAC1P == "6" & HISP == "01" ~ "Asian_NH",      # Asian, not Hispanic
      HISP == "02" ~ "Hispanic",                     # Hispanic (any race)
      TRUE ~ "Other"
    ),
    
    # Convert SCHL to numeric (handles leading zeros automatically)
    SCHL_num = base::as.numeric(SCHL),  # "21" becomes 21, "bb" becomes NA
    college_plus = base::ifelse(SCHL_num >= 21, 1, 0),
    graduate_degree = base::ifelse(SCHL_num >= 22, 1, 0),
    
    # Demographics and controls
    age_group = base::cut(AGEP, breaks = c(0, 25, 35, 45, 55, 65, 100)),
    married = base::ifelse(MAR == "01", 1, 0),             # Married is probably "01"
    income_quintile = dplyr::ntile(HINCP, 5),
    full_time = base::ifelse(WKHP >= 35, 1, 0),
    
    # Proxy for having children - need to check HHT codes
    likely_has_children = dplyr::case_when(
      HHT %in% c("01", "02") & NP >= 3 ~ 1,         # Family households with 3+ people
      HHT %in% c("03", "04") & NP >= 2 ~ 1,  
      TRUE ~ 0
    )
  ) |>
  dplyr::filter(
    AGEP >= 25 & AGEP <= 65,  # Working age adults
    race_ethnicity != "Other",
    !base::is.na(SCHL_num)  # Remove records with invalid education codes
  )

cat("Fixed analysis dataset dimensions:", base::dim(analysis_ready), "\n")

# Check the race/ethnicity distribution
cat("Race/ethnicity distribution:\n")

# Create distribution table
race_distribution <- base::as.data.frame(base::table(analysis_ready$race_ethnicity, useNA = "always"))
base::names(race_distribution) <- c("Race_Ethnicity", "Count")
```

::: {.content-visible when-format="html"}
```{r}
#| label: race-distribution-html
#| echo: false

DT::datatable(race_distribution,
              caption = "Race/Ethnicity Distribution in Analysis Dataset",
              options = base::list(pageLength = 10, dom = 't'),
              rownames = FALSE)
```
:::

::: {.content-visible unless-format="html"}
```{r}
#| label: race-distribution-pdf
#| echo: false

flextable::flextable(race_distribution) |>
  flextable::set_caption(caption = "Race/Ethnicity Distribution in Analysis Dataset") |>
  flextable::add_header_lines(values = "Race/Ethnicity Distribution") |>
  flextable::color(i = 1, color = "blue", part = "header") |>
  flextable::italic(i = 1, part = "header") |>
  flextable::align(i = 1, align = "center", part = "header") |>
  flextable::fontsize(i = 1, size = 14, part = "header") |>
  flextable::bg(i = 1, bg = "white", part = "header") |>
  flextable::bg(i = 2, bg = "palegreen", part = "header") |>
  flextable::colformat_double(j = "Count", big.mark = ",", digits = 0) |>
  ftExtra::colformat_md() |>
  flextable::autofit()
```
:::



STEP 4: Example hypothesis test

```{r}
#| label: step4-hypothesis-test

# Hypothesis 1: Racial achievement gaps controlling for socioeconomic factors
hypothesis_1 <- analysis_ready |>
  dplyr::filter(AGEP >= 30 & AGEP <= 40) |>  # Peak career-building years
  dplyr::group_by(year, race_ethnicity, income_quintile, likely_has_children, married) |>
  dplyr::summarise(
    college_plus_rate = stats::weighted.mean(college_plus, PWGTP, na.rm = TRUE),
    graduate_degree_rate = stats::weighted.mean(graduate_degree, PWGTP, na.rm = TRUE),
    n = base::sum(PWGTP), 
    .groups = "drop"
  ) |>
  dplyr::filter(n >= 30)  # Minimum sample size for reliable estimates

# Create the line graph test
hypothesis_1_plot <- ggplot2::ggplot(hypothesis_1, ggplot2::aes(x = year, y = college_plus_rate, color = race_ethnicity)) +
  ggplot2::geom_line(size = 1.2) +
  ggplot2::facet_wrap(~base::paste("Income Q", income_quintile, "| Children:", likely_has_children)) +
  ggplot2::labs(
    title = "College Completion Rates: Apples-to-Apples Comparison",
    subtitle = "Controlling for income and family structure",
    y = "College Completion Rate",
    caption = "If gaps persist within same income/family groups, socioeconomic factors don't explain them"
  ) +
  ggplot2::theme_minimal()

base::print(hypothesis_1_plot)

```
